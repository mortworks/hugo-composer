{{- /* composer/route-post.html — stable version for structure & template posts */ -}}
{{- $debug := site.Params.composer.debug | default false -}}

{{- $page := . -}}
{{- $structure := .Params.structure | default nil -}}
{{- $template := .Params.template -}}
{{- $anchors  := .Params.anchors  | default nil -}}

{{/* Load structure from template if present */}}
{{- if and (not $structure) $template -}}
  {{- $tpl := index site.Data.templates $template -}}
  {{- if $tpl -}}
    {{- $structure = $tpl.structure -}}
    {{- if not $anchors }}{{- $anchors = $tpl.anchors -}}{{- end -}}
    {{- if $debug -}}<!-- composer: loaded template {{ $template }} -->{{- end -}}
  {{- else -}}
    <div class="template-error">
      ⚠️ Template <code>{{ $template }}</code> not found in <code>data/templates.yaml</code>.
    </div>
  {{- end -}}
{{- end -}}

{{/* If we have a structure list, render it */}}
{{- if $structure -}}
  {{- if $debug -}}<!-- composer: rendering structure with {{ len $structure }} blocks -->{{- end -}}
  {{- partial "composer/render-structure.html" (dict "Page" $page "Structure" $structure "Anchors" $anchors) -}}
{{- else -}}
  {{/* Fallback to normal markdown content */}}
  {{- if not (.Param "disableAnchoredHeadings") -}}
    {{- partial "anchored_headings.html" .Content -}}
  {{- else -}}
    {{- .Content -}}
  {{- end -}}
{{- end -}}
